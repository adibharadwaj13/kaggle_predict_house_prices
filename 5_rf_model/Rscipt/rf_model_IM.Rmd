---
title: "R Notebook"
output: html_notebook
author: "Ileena Mitra"
date: "March 20th, 2017"
---

#Math 289c Final Project

Set up
```{r echo=FALSE, warning=FALSE}
library(readr)
set.seed(888)
df <- read_csv("~/Google_Drive/UCSD/Winter2017/ExpDataAnalysis/Projects/Final/kaggle_predict_house_prices/cleaned_data/cleandmy.csv")
rownames(df) <- df$Id
df$Id <- NULL
df$X <- NULL
df$X1 <- NULL
df <- na.omit(df) #RF cannot work on any NA
df$LogSalePrice <- log(df$SalePrice)

#set interest var
response.var = "LogSalePrice"
```

Split data into test and training sets
```{r}
total.n <- nrow(df)
rand <- sample(seq(1, total.n), total.n*(2/3), replace = F)
train = df[rand,]
test = df[-rand,]
```

Use significant key variables for model
```{r}
num.vars = c("MSSubClass", "LotArea", "OverallQual", "OverallCond", "YearBuilt", "YearRemodAdd", "FirstFlrSF", "SecondFlrSF", "BsmtFullBath", "FullBath", "Fireplaces", "GarageArea", "WoodDeckSF", "ScreenPorch", "PoolArea")
char.vars = c("MSZoning.FV", "MSZoning.RH", "MSZoning.RL", "MSZoning.RM", "Neighborhood.BrDale", "Neighborhood.BrkSide", "Neighborhood.CollgCr", "Neighborhood.Edwards", "Neighborhood.Gilbert", "Neighborhood.IDOTRR", "Neighborhood.MeadowV", "Neighborhood.Mitchel", "Neighborhood.NAmes", "Neighborhood.OldTown", "NeighborhoodSawyer", "Neighborhood.SWISU", "Condition2PosA", "BldgType.Twnhs", "BldgType.TwnhsE", "HouseStyle.1Story", "HouseStyle.SFoyer", "RoofMatl.WdShngl", "Foundation.PConc", "Heating.GasW", "HeatingQC.Fa", "HeatingQC.Gd", "HeatingQC.TA")
all.vars = c(num.vars, char.vars)
```

Implement random forest model
Notes from: http://dni-institute.in/blogs/random-forest-using-r-step-by-step-tutorial/

Build Formula
```{r}
library(randomForest)
#IF WANT TO USE ALL VARIABLES
rf.form.all = as.formula( paste(response.var, "~ ."))

#IF WANT TO USE SELECTED KEY VARIABLES
# add + sign between exploratory variables
varNames <- paste(num.vars, collapse = "+")
 
# Add response variable and convert to a formula object
rf.form.key <- as.formula(paste(response.var, varNames, sep = "~"))
```

Plot decision trees
```{r}
train <- na.omit(train)
train.rf <- randomForest(rf.form.all,
                              train,
                              ntree=500,
                              importance=T)

plot(train.rf)
```


RF Variable Selection Method
```{r}
# Variable Importance Plot
varImpPlot(train.rf,
           sort = T,
           main="Variable Importance",
           n.var=20)

# Variable Importance Table
var.imp <- data.frame(importance(train.rf,
           type=2))
# make row names as columns
var.imp$Variables <- row.names(var.imp)
var.imp[order(var.imp$IncNodePurity,decreasing = T),]
```


```{r}
# Predicting response variable
test$PredictedSalePrice <- predict(train.rf, test)
predicted.response.var = "PredictedSalePrice"
library("ggplot2")
qplot(data=test, x=LogSalePrice, y=PredictedSalePrice)
cor.test(test$LogSalePrice, test$PredictedSalePrice, method = "spearman")
```


```{r}
library("ModelMetrics")
test.rmse = rmse(test$LogSalePrice, test$PredictedSalePrice)
test.rmse.norm = test.rmse/(max(test[,response.var])-min(test[,response.var]))
test.rmse.norm
```

